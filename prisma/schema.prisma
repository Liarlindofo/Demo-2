generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model StackUser {
  id                   String    @id @default(uuid())
  primaryEmail         String?   @unique
  displayName          String?
  profileImageUrl      String?
  primaryEmailVerified DateTime?
  lastActiveAt         DateTime?
  userId               String?   @unique
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User?     @relation("StackUserUser", fields: [userId], references: [id], onDelete: Cascade)
  primaryForUser       User?     @relation("UserStackUser")

  @@map("stack_users")
}

model User {
  id           String        @id @default(cuid())
  email        String?       @unique
  username     String?       @unique
  password     String?
  fullName     String?
  cnpj         String?
  birthDate    DateTime?
  isAdmin      Boolean       @default(false)
  stackUserId  String?       @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  name         String?
  stackUserRef StackUser?    @relation("StackUserUser")
  stackUser    StackUser?    @relation("UserStackUser", fields: [stackUserId], references: [id])
  stores       Store[]
  apis         UserAPI[]
  whatsappBots WhatsAppBot[]
  botSettings  BotSettings?

  @@map("users")
}

model UserAPI {
  id         String       @id @default(cuid())
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  type       String
  apiKey     String
  baseUrl    String?
  storeId    String
  status     String       @default("disconnected")
  isSyncing  Boolean      @default(false)
  enabled    Boolean      @default(true)
  lastTest   DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  salesDaily SalesDaily[]
  syncRuns   SyncRun[]

  @@index([userId])
  @@index([storeId])
  @@index([enabled])
  @@map("user_apis")
}

model Store {
  id        String   @id @default(cuid())
  name      String
  address   String?
  phone     String?
  cnpj      String?
  isActive  Boolean  @default(true)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("stores")
}

model SalesDaily {
  id              String   @id @default(cuid())
  apiId           String
  storeId         String
  date            DateTime
  totalOrders     Int
  totalSales      Float
  uniqueCustomers Int      @default(0)
  channels        Json?
  createdAt       DateTime @default(now())
  api             UserAPI  @relation(fields: [apiId], references: [id], onDelete: Cascade)

  @@unique([apiId, date], name: "sales_daily_api_date_unique")
  @@index([apiId, date])
  @@index([storeId])
  @@map("sales_daily")
}

model Sale {
  id          String   @id @default(cuid())
  userId      String
  storeId     String
  externalId  String
  saleDateUtc DateTime
  totalAmount Float?
  rawJson     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@unique([storeId, externalId], name: "storeId_externalId")
  @@index([storeId])
  @@index([userId])
  @@map("sales")
}

model SalesRawPage {
  id        String   @id @default(cuid())
  syncRunId String
  pageIndex Int
  payload   Json?
  createdAt DateTime @default(now())
  run       SyncRun  @relation(fields: [syncRunId], references: [id], onDelete: Cascade)

  @@index([syncRunId])
  @@map("sales_raw_pages")
}

model SyncRun {
  id               String         @id @default(cuid())
  userApiId        String
  storeId          String
  status           String
  startPeriod      DateTime
  endPeriod        DateTime
  startedAt        DateTime       @default(now())
  endedAt          DateTime?
  lastUrl          String?
  totalRequests    Int            @default(0)
  totalRecordsRaw  Int            @default(0)
  totalAfterFilter Int            @default(0)
  syncedCount      Int            @default(0)
  errorsCount      Int            @default(0)
  rawPages         SalesRawPage[]
  errors           SyncError[]
  api              UserAPI        @relation(fields: [userApiId], references: [id], onDelete: Cascade)

  @@index([userApiId])
  @@index([status])
  @@map("sync_runs")
}

model SyncError {
  id             String   @id @default(cuid())
  syncRunId      String
  run            SyncRun  @relation(fields: [syncRunId], references: [id], onDelete: Cascade)
  message        String
  payloadPreview String?
  createdAt      DateTime @default(now())

  @@index([syncRunId])
  @@map("sync_errors")
}

model WhatsAppBot {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  slot            Int
  isConnected     Boolean  @default(false)
  connectedNumber String?
  sessionJson     Json?
  qrCode          String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, slot])
  @@index([userId])
  @@index([isConnected])
  @@map("whatsapp_bots")
}

model BotSettings {
  userId        String   @id
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  botName       String?  @default("Assistente")
  storeType     String?  @default("restaurant")
  contextLimit  Int      @default(10)
  lineLimit     Int      @default(5)
  basePrompt    String?  @db.Text
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
  @@map("bot_settings")
}
