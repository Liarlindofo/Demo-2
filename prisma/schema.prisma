// Prisma Schema - Platefull Platform
// PostgreSQL via Neon

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Stack Auth User
model StackUser {
  id                    String    @id @default(uuid())
  primaryEmail          String?   @unique
  displayName           String?
  profileImageUrl       String?
  primaryEmailVerified  DateTime?
  lastActiveAt          DateTime?
  userId                String?   @unique
  user                  User?     @relation("StackUserBelongsToUser", fields: [userId], references: [id], onDelete: Cascade)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("stack_users")
}

// Application User
model User {
  id          String      @id @default(cuid())
  email       String      @unique
  username    String      @unique
  password    String?     // Opcional para Stack Auth users
  fullName    String?
  cnpj        String?
  birthDate   DateTime?
  isAdmin     Boolean     @default(false)
  stackUserId String?     @unique
  stackUser   StackUser?  @relation("UserHasStackUser", fields: [stackUserId], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  stores      Store[]
  apis        UserAPI[]

  @@map("users")
}

// User APIs (Saipos, WhatsApp, etc)
model UserAPI {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  type        String        // 'saipos' or 'whatsapp'
  apiKey      String
  baseUrl     String?
  storeId     String
  status      String        @default("disconnected")
  isSyncing   Boolean       @default(false)
  enabled     Boolean       @default(true)
  lastTest    DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  salesDaily  SalesDaily[]
  syncRuns    SyncRun[]

  @@index([userId])
  @@index([storeId])
  @@index([enabled])
  @@map("user_apis")
}

// Store
model Store {
  id        String    @id @default(cuid())
  name      String
  address   String?
  phone     String?
  cnpj      String?
  isActive  Boolean   @default(true)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@map("stores")
}

// Sales Daily
model SalesDaily {
  id              String    @id @default(cuid())
  apiId           String
  api             UserAPI   @relation(fields: [apiId], references: [id], onDelete: Cascade)
  storeId         String
  date            DateTime
  totalOrders     Int
  totalSales      Float
  uniqueCustomers Int       @default(0)
  channels        Json?
  createdAt       DateTime  @default(now())

  @@unique([apiId, date], name: "sales_daily_api_date_unique")
  @@index([apiId, date])
  @@index([storeId])
  @@map("sales_daily")
}

// Individual raw sales (normalized per sale)
model Sale {
  id           String    @id @default(cuid())
  userId       String
  storeId      String
  externalId   String
  saleDateUtc  DateTime
  totalAmount  Float?
  rawJson      Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())

  @@unique([storeId, externalId], name: "storeId_externalId")
  @@index([storeId])
  @@index([userId])
  @@map("sales")
}

// Raw pages fetched from Saipos during sync (for debugging)
model SalesRawPage {
  id         String    @id @default(cuid())
  syncRunId  String
  run        SyncRun   @relation(fields: [syncRunId], references: [id], onDelete: Cascade)
  pageIndex  Int
  payload    Json?
  createdAt  DateTime  @default(now())

  @@index([syncRunId])
  @@map("sales_raw_pages")
}

// Sync Run (tracking)
model SyncRun {
  id               String    @id @default(cuid())
  userApiId        String
  api              UserAPI   @relation(fields: [userApiId], references: [id], onDelete: Cascade)
  storeId          String
  status           String    // 'running' | 'success' | 'error'
  startPeriod      DateTime
  endPeriod        DateTime
  startedAt        DateTime  @default(now())
  endedAt          DateTime?
  lastUrl          String?
  totalRequests    Int       @default(0)
  totalRecordsRaw  Int       @default(0)
  totalAfterFilter Int       @default(0)
  syncedCount      Int       @default(0)
  errorsCount      Int       @default(0)

  rawPages         SalesRawPage[]
  errors           SyncError[]

  @@index([userApiId])
  @@index([status])
  @@map("sync_runs")
}

// Sync Error
model SyncError {
  id             String    @id @default(cuid())
  syncRunId      String
  run            SyncRun   @relation(fields: [syncRunId], references: [id], onDelete: Cascade)
  message        String
  payloadPreview String?
  createdAt      DateTime  @default(now())

  @@index([syncRunId])
  @@map("sync_errors")
}
